# --- Libraries ---
library(tidyverse)
library(openxlsx)
library(lubridate)
library(readxl)
library(stringr)

# --- Directories ---
input_dir <- "C:/Reports/Provider Prod Data Pulls"
output_dir <- file.path(input_dir, "Filtered/By ISO Week")
if (!dir.exists(output_dir)) dir.create(output_dir, recursive = TRUE)

# --- File Detection ---
files <- list.files(input_dir, pattern = "\\.xlsx$", full.names = TRUE)
prod_file <- files[str_detect(basename(files), regex("Prov Prod Data", ignore_case = TRUE))][1]
appt_file <- files[str_detect(basename(files), regex("Kept_Appointments|NG Kept|Appt|appointments", ignore_case = TRUE)) &
                     !str_detect(basename(files), regex("PROD|Productivity", ignore_case = TRUE))][1]
specialty_file <- files[str_detect(basename(files), regex("Provider_Productivity_Weeks|special", ignore_case = TRUE))][1]

cat("??? Matched files:\n")
cat("   - Productivity:", prod_file, "\n")
cat("   - Appointments:", appt_file, "\n")
cat("   - Specialty:", specialty_file, "\n")

if (is.na(prod_file) || !file.exists(prod_file)) stop("??? Productivity file not found.")
if (is.na(appt_file) || !file.exists(appt_file)) stop("??? Appointment file not found.")
if (is.na(specialty_file) || !file.exists(specialty_file)) stop("??? Specialty file not found.")

# --- Load Data ---
Prod_Raw <- read_excel(prod_file)
Appt_Raw <- read_excel(appt_file)
Specialty_Data <- read_excel(specialty_file) %>%
  select(Provider, `Provider Specialty`, `Productivity Target?`)

# --- Productivity Cleanup ---
Prod_Cleaned <- Prod_Raw %>%
  mutate(ISoweek_start_date = isoweek(ymd(week_end_date)))

Charting_Time <- Prod_Cleaned %>% filter(category == "Charting Time")
Exempt_Time <- Prod_Cleaned %>% filter(`Prevent Appointments?` == "Y" & !category %in% c("Charting Time", "Administrative Time"))
Non_Exempt_Time <- Prod_Cleaned %>% filter(`Prevent Appointments?` == "N")
Bound_NonExempt <- bind_rows(Non_Exempt_Time, Charting_Time)

Non_Exemption_Summary <- Bound_NonExempt %>%
  group_by(ISoweek_start_date, Provider) %>%
  summarise(
    `Total Non Exemption Time (Mins)` = round(sum(duration), 2),
    `Total Non-Exempt Hours On Schedule` = round(sum(duration)/60, 2),
    week_start_date = first(week_start_date),
    week_end_date = first(week_end_date),
    .groups = "drop"
  )

Exemption_Summary <- Exempt_Time %>%
  group_by(ISoweek_start_date, Provider) %>%
  summarise(
    `Total Exemption Time` = sum(duration),
    `Total Exempt Hours on Schedule` = round(sum(duration) / 60, 2),
    .groups = "drop"
  )

# --- Appointments Cleanup ---
Kept_Appt_Summary <- Appt_Raw %>%
  rename(Provider = `Res Name`) %>%
  mutate(
    Appt_Date = ymd(`Appt Dt`),
    ISoweek_start_date = isoweek(Appt_Date)) %>%
  group_by(ISoweek_start_date, Provider) %>%
  summarise(`Total Number of Kept Appointments` = n(), .groups = "drop")

# --- Join All ---
Final_Pivot <- Non_Exemption_Summary %>%
  full_join(Kept_Appt_Summary, by = c("Provider", "ISoweek_start_date")) %>%
  full_join(Exemption_Summary, by = c("Provider", "ISoweek_start_date")) %>%
  mutate(`Total Productivity` = round(`Total Number of Kept Appointments` / `Total Non-Exempt Hours On Schedule`, 2)) %>%
  distinct(Provider, ISoweek_start_date, .keep_all = TRUE)

# --- ISO Week Label Mapping ---
IsoWeekMapping <- Final_Pivot %>%
  filter(!is.na(week_start_date)) %>%
  group_by(ISoweek_start_date) %>%
  summarise(
    Min_Date = min(ymd(week_start_date), na.rm = TRUE),
    Max_Date = max(ymd(week_end_date), na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(Iso_Week_Label = paste0(format(Min_Date, "%Y-%m-%d"), " to ", format(Max_Date, "%Y-%m-%d")))

Final_Pivot_Labeled <- Final_Pivot %>%
  left_join(IsoWeekMapping, by = "ISoweek_start_date")

week_label_order <- Final_Pivot_Labeled %>%
  filter(!is.na(Iso_Week_Label)) %>%
  arrange(ISoweek_start_date) %>%
  pull(Iso_Week_Label) %>%
  unique()

# --- Weekly Heatmap Tables ---
Productivity_Summary <- Final_Pivot_Labeled %>%
  select(Provider, Iso_Week_Label, `Total Productivity`) %>%
  distinct() %>%
  pivot_wider(names_from = Iso_Week_Label, values_from = `Total Productivity`) %>%
  full_join(Specialty_Data, by = "Provider") %>%
  arrange(Provider)

Kept_Appt_Summary <- Final_Pivot_Labeled %>%
  select(Provider, Iso_Week_Label, `Total Number of Kept Appointments`) %>%
  pivot_wider(names_from = Iso_Week_Label, values_from = `Total Number of Kept Appointments`, values_fill = 0) %>%
  select(Provider, all_of(week_label_order))

Non_Exemption_Summary <- Final_Pivot_Labeled %>%
  select(Provider, Iso_Week_Label, `Total Non-Exempt Hours On Schedule`) %>%
  distinct() %>%
  pivot_wider(names_from = Iso_Week_Label, values_from = `Total Non-Exempt Hours On Schedule`, values_fill = 0) %>%
  select(Provider, all_of(week_label_order))

Exemption_Summary <- Final_Pivot_Labeled %>%
  select(Provider, Iso_Week_Label, `Total Exempt Hours on Schedule`) %>%
  distinct() %>%
  pivot_wider(names_from = Iso_Week_Label, values_from = `Total Exempt Hours on Schedule`, values_fill = 0) %>%
  select(Provider, all_of(week_label_order))

# --- 4-Week Aggregated Summary ---
ProviderSummary <- Final_Pivot %>%
  mutate(Four_Week_Group = ((ISoweek_start_date - 1) %/% 4) + 1) %>%
  group_by(Provider, Four_Week_Group) %>%
  summarise(
    `Total Kept Appointments` = if (all(is.na(`Total Number of Kept Appointments`))) NA else sum(`Total Number of Kept Appointments`, na.rm = TRUE),
    `Total Non-Exempt Hours On Schedule` = if (all(is.na(`Total Non-Exempt Hours On Schedule`))) NA else sum(`Total Non-Exempt Hours On Schedule`, na.rm = TRUE),
    `Total Exempt Hours on Schedule` = if (all(is.na(`Total Exempt Hours on Schedule`))) NA else sum(`Total Exempt Hours on Schedule`, na.rm = TRUE),
    `Average Productivity` = if (
      all(is.na(`Total Number of Kept Appointments`)) | all(is.na(`Total Non-Exempt Hours On Schedule`)) | sum(`Total Non-Exempt Hours On Schedule`, na.rm = TRUE) == 0
    ) NA else round(
      sum(`Total Number of Kept Appointments`, na.rm = TRUE) /
        sum(`Total Non-Exempt Hours On Schedule`, na.rm = TRUE), 2
    ),
    .groups = "drop"
  ) %>%
  full_join(Specialty_Data, by = "Provider")

# --- Save Workbook ---
output_file <- file.path(output_dir, paste0("ISO_Week_Provider_Summary_", format(Sys.Date(), "%Y-%m-%d"), ".xlsx"))

wb <- createWorkbook()

headerStyle <- createStyle(fontSize = 11, fontColour = "white", fgFill = "#4F81BD", halign = "center", valign = "center", textDecoration = "bold", border = "Bottom")
bodyStyle <- createStyle(halign = "center", valign = "center", wrapText = TRUE)

add_styled_sheet <- function(wb, sheet_name, data) {
  addWorksheet(wb, sheet_name)
  writeDataTable(wb, sheet = sheet_name, x = data, withFilter = TRUE, headerStyle = headerStyle)
  addStyle(wb, sheet = sheet_name, style = bodyStyle, rows = 2:(nrow(data) + 1), cols = 1:ncol(data), gridExpand = TRUE)
  freezePane(wb, sheet = sheet_name, firstRow = TRUE)
  setColWidths(wb, sheet = sheet_name, cols = 1:ncol(data), widths = "auto")
}

add_styled_sheet(wb, "Data", Productivity_Summary)
add_styled_sheet(wb, "Kept Appointments", Kept_Appt_Summary)
add_styled_sheet(wb, "Non-Exemption Time", Non_Exemption_Summary)
add_styled_sheet(wb, "Exemption Time", Exemption_Summary)
add_styled_sheet(wb, "Summary", ProviderSummary)

saveWorkbook(wb, file = output_file, overwrite = TRUE)
cat("??? ISO Week Summary with calculations exported to:\n", output_file, "\n")